/*
 * @LastEditors: aFei
 * @LastEditTime: 2022-12-05 17:39:31
*/
(function(i){typeof define=="function"&&define.amd?define(i):i()})(function(){"use strict";var i={CSIZE:26,OFFSET:15,pg:null,shape:null,nextshape:null,interval:550,timer:null,wall:null,RN:20,CN:10,lines:0,score:0,SCORES:[0,10,30,60,120],GAMEOVER:0,RUNNING:1,PAUSE:2,state:1,randomShape(){var e=Math.floor(Math.random()*7);switch(e){case 0:return new T;case 1:return new O;case 2:return new I;case 3:return new Z;case 4:return new S;case 5:return new L;case 6:return new J}},paint(){this.pg.innerHTML=this.pg.innerHTML.replace(/<(img)[^>]*>/g,""),this.paintShape(),this.paintNextShape(),this.paintWall(),this.paintScore()},paintCell(e,t){e.src=t.src,e.style.left=this.OFFSET+this.CSIZE*t.c+"px",e.style.top=this.OFFSET+this.CSIZE*t.r+"px"},paintShape(){for(var e=document.createDocumentFragment(),t=0;t<this.shape.cells.length;t++){var s=this.shape.cells[t],a=new Image;this.paintCell(a,s),e.appendChild(a)}this.pg.appendChild(e)},paintNextShape(){for(var e=document.createDocumentFragment(),t=0;t<this.nextshape.cells.length;t++){var s=this.nextshape.cells[t],a=new Image;this.paintCell(a,s),a.style.left=parseFloat(a.style.left)+10*this.CSIZE+"px",a.style.top=parseFloat(a.style.top)+this.CSIZE+"px",e.appendChild(a)}this.pg.appendChild(e)},paintWall(){for(var e=document.createDocumentFragment(),t=0;t<this.RN;t++)for(var s=0;s<this.CN;s++)if(this.wall[t][s]!==void 0){var a=this.wall[t][s],h=new Image;this.paintCell(h,a),e.appendChild(h)}this.pg.appendChild(e)},paintScore(){document.getElementById("lines").innerHTML=this.lines,document.getElementById("score").innerHTML=this.score},start:function(){this.state=this.RUNNING,this.score=0,this.lines=0,this.wall=[];for(var e=0;e<this.RN;e++)this.wall[e]=new Array(this.CN);this.pg=document.querySelector(".playground"),this.shape=this.randomShape(),this.nextshape=this.randomShape(),this.paint(),this.timer=setInterval(this.moveDown.bind(this),this.interval),document.onkeydown=function(t){switch(t.keyCode){case 32:this.state===this.RUNNING&&this.hardDrop();break;case 37:this.state===this.RUNNING&&this.moveLeft();break;case 38:this.state===this.RUNNING&&this.rotateR();break;case 39:this.state===this.RUNNING&&this.moveRight();break;case 40:this.state===this.RUNNING&&this.moveDown();break;case 90:this.state===this.RUNNING&&this.rotateL();break;case 83:this.state===this.GAMEOVER&&this.start();break;case 81:this.state!==this.GAMEOVER&&this.quiet();break;case 80:this.state===this.RUNNING&&this.pause();break;case 67:this.state===this.PAUSE&&this.starAgin();break}}.bind(this)},moveDown(){if(this.canDown())this.shape.moveDown(),this.paint();else{this.landIntoWall();var e=this.deleteRows();if(this.lines+=e,this.score+=this.SCORES[e],this.isGameOver())this.shape=this.nextshape,this.nextshape=this.randomShape(),this.paint();else{clearInterval(this.timer);var t=new Image;t.src="img/game-over.png",t.className="pause",this.pg.appendChild(t),this.state=this.GAMEOVER}}},canDown:function(){for(var e=0;e<this.shape.cells.length;e++){var t=this.shape.cells[e];if(t.r==this.RN-1||this.wall[t.r+1][t.c]!=null)return!1}return!0},hardDrop(){for(;this.canDown();)this.moveDown()},moveLeft(){this.canLeft()&&(this.shape.moveLeft(),this.paint())},canLeft(){for(var e=0;e<this.shape.cells.length;e++){var t=this.shape.cells[e];if(t.c==0||this.wall[t.r][t.c-1]!==void 0)return!1}return!0},moveRight(){this.canRight()&&(this.shape.moveRight(),this.paint())},canRight(){for(var e=0;e<this.shape.cells.length;e++){var t=this.shape.cells[e];if(t.c==this.CN-1||this.wall[t.r][t.c+1]!==void 0)return!1}return!0},rotateR(){this.shape.rotateR(),this.canRotate()||this.shape.rotateL(),this.paint()},rotateL(){this.shape.rotateL(),this.canRotate()||this.shape.rotateR(),this.paint()},canRotate(){for(var e=0;e<this.shape.cells.length;e++){var t=this.shape.cells[e];if(t.c<0||t.c>=this.CN||t.r<0||t.r>=this.RN||this.wall[t.r][t.c]!==void 0)return!1}return!0},landIntoWall(){for(var e=0;e<this.shape.cells.length;e++){var t=this.shape.cells[e];this.wall[t.r][t.c]=t}},deleteRows(){for(var e=this.RN-1,t=0;e>=0&&this.wall[e].join("")!=="";e--){var s=/^,|,,|,$/;if(!s.test(this.wall[e].toString())){if(this.deleteRow(e),t++,t==4)break;e++}}return t},deleteRow(e){for(var t=e;t>=0;t--)if(this.wall[t-1].join("")!=="")for(var s=0;s<this.wall[t].length;s++)this.wall[t][s]=this.wall[t-1][s],this.wall[t][s]&&this.wall[t][s].r++;else{for(var s=0;s<this.wall[t].length;s++)this.wall[t][s]=void 0;break}},pause(){clearInterval(this.timer);var e=new Image;e.src="img/pause.png",e.className="pause",this.pg.appendChild(e),this.state=this.PAUSE},starAgin(){this.timer=setInterval(this.moveDown.bind(this),this.interval),this.state=this.RUNNING},isGameOver(){for(var e=0;e<this.nextshape.cells.length;e++){var t=this.nextshape.cells[e];if(this.wall[t.r][t.c]!==void 0)return!1}return!0},quiet(){clearInterval(this.timer),confirm("\u786E\u5B9A\u8981\u9000\u51FA\uFF1F")?close():this.timer=setInterval(this.moveDown.bind(this),this.interval)}};i.start()});
